[gd_scene load_steps=23 format=2]

[ext_resource path="res://Sprites/Player/charhatscuba/Charhatscuba4.png" type="Texture" id=1]
[ext_resource path="res://Sprites/Player/charhatscuba/Charhatscuba5.png" type="Texture" id=2]
[ext_resource path="res://Sprites/Player/charhatscuba/Charhatscuba6.png" type="Texture" id=3]
[ext_resource path="res://Sprites/Player/charhatscuba/Charhatscuba7.png" type="Texture" id=4]
[ext_resource path="res://Sprites/Player/charhatscuba/Charhatscuba8.png" type="Texture" id=5]
[ext_resource path="res://Sprites/Player/charhatscuba/Charhatscuba1.png" type="Texture" id=6]
[ext_resource path="res://Sprites/Player/charhatscuba/Charhatscuba2.png" type="Texture" id=7]
[ext_resource path="res://Sprites/Player/charhatscuba/Charhatscuba3.png" type="Texture" id=8]
[ext_resource path="res://AnimatedSprite.gd" type="Script" id=9]
[ext_resource path="res://Music/Diving.ogg" type="AudioStream" id=10]
[ext_resource path="res://Sound Effects/Water Interaction/jump in water.ogg" type="AudioStream" id=11]
[ext_resource path="res://Sound Effects/Water Interaction/get out.ogg" type="AudioStream" id=12]
[ext_resource path="res://Sound Effects/GunshotRifle_BW.57683.ogg" type="AudioStream" id=13]
[ext_resource path="res://Sprites/Decor/Radio.png" type="Texture" id=14]
[ext_resource path="res://Music/ontheboat.ogg" type="AudioStream" id=15]
[ext_resource path="res://Sprites/Particles/note.png" type="Texture" id=16]
[ext_resource path="res://GUI.tscn" type="PackedScene" id=17]

[sub_resource type="GDScript" id=1]

script/source = "extends KinematicBody2D
var motion = Vector2()
var normalVector = Vector2(0,-1)
var swimSpeed = 150
var jumpSpeed = -300
var maxVertSpeed = 400
var gravity = 6
var setGravity = 6
var friction = 5
var grounded = 0
var in_water = 0
var can_jump = 1

var health = 4
var breath = 100

var can_shoot = true
var timer = null
var bullet_delay = 0.3

const BULLET_SCENE = preload(\"res://Bullet.tscn\")

func _ready():
	timer = Timer.new()
	timer.set_one_shot(true)
	timer.set_wait_time(bullet_delay)
	timer.connect(\"timeout\", self, \"on_timeout_complete\")
	add_child(timer)
	get_node(\"SFX/Radio/AudioStreamPlayer2D\")._set_playing(true)
func on_timeout_complete():
	can_shoot = true

func _physics_process(delta):
	get_node(\"Camera2D/gui/ViewportContainer/TextureRect2/HBoxContainer/health\").set_text(str(health))
	get_node(\"Camera2D/gui/ViewportContainer/TextureRect2/HBoxContainer/breath\").set_text(str(breath))
	if in_water == 1:
		breath -= .1
		if breath <= 0:
			health -= 1
	if is_on_floor():
		grounded = 1
		gravity = 0 
		can_jump = 1
		print(\"GROUND\")
	elif !is_on_floor():
		grounded = 0
		gravity = setGravity
		print(\"NOTGROUNDED\")
	if is_on_ceiling(): #halt vertical momentum if you hit the ceiling
		motion.y = 0
	if grounded == 0: #bring to floor if you're not on the floor
		motion.y += gravity
	elif grounded == 1 :
		motion.y = setGravity
		if motion.x == 0:
			get_node(\"AnimatedSprite\").set_animation(\"Ground\")
		elif Input.is_action_pressed('ui_right'):
			get_node(\"AnimatedSprite\").set_animation(\"Walk\")
		elif Input.is_action_pressed('ui_left'):
			get_node(\"AnimatedSprite\").set_animation(\"Walk\")
	if motion.y > gravity and grounded == 0 and in_water == 1:
		get_node(\"AnimatedSprite\").set_animation(\"Swim\")
		print(\"FALLING\")
	if Input.is_action_just_pressed('ui_up') and can_jump == 1 :#swim up
		get_node(\"AnimatedSprite\").set_frame(0) #reset swim stroke on up input
		if in_water == 0: #out of water, never do the stroke animation on jump
			get_node(\"AnimatedSprite\").set_animation(\"Jump\")
		elif grounded == 1:#set sprite to jump if on floor or to swim if not
			get_node(\"AnimatedSprite\").set_animation(\"Jump\")
		elif grounded == 0:
			get_node(\"AnimatedSprite\").set_animation(\"Stroke\")
		if in_water == 0:
			can_jump = 0
		motion.y = min(motion.y, 0) #reset vertical momentum if you're falling
		motion.y += jumpSpeed
	if Input.is_action_pressed('ui_right'): #swim left and right
		motion.x = swimSpeed
		get_node(\"AnimatedSprite\").set_flip_h(false)
	elif Input.is_action_pressed('ui_left'):
		get_node(\"AnimatedSprite\").set_flip_h(true)
		motion.x = -swimSpeed
	else:
		motion.x -= sign(motion.x)*friction
		#if abs(motion.x) <friction:
			#motion.x = 0
	
	if abs(motion.y) > maxVertSpeed:
		motion.y = sign(motion.y)*maxVertSpeed
	print (motion , setGravity)
	move_and_slide(motion,normalVector,5,4,.8)

	var player = get_node(\"Position2D\").get_global_position()	#discern between water and air
	if player.y <= 0:
		swimSpeed = 300
		jumpSpeed = -1000
		maxVertSpeed = 600
		setGravity = 12
		friction = 10
		grounded = 0
		breath = 100
		if in_water == 1:
			get_node(\"SFX/Radio/AudioStreamPlayer2D\")._set_playing(true)
			get_node(\"SFX/Exit Water\")._set_playing(true)
			get_node(\"SFX/Shoot\").set_bus(\"Air\")
			get_node(\"SFX/Music\")._set_playing(false)
		in_water = 0
	elif player.y > 0:
		swimSpeed = 150
		jumpSpeed = -300
		maxVertSpeed = 400
		setGravity = 6
		friction = 5
		grounded = 0
		can_jump = 1
		if in_water == 0:
			get_node(\"SFX/Radio/AudioStreamPlayer2D\")._set_playing(false)
			get_node(\"SFX/Enter Water\")._set_playing(true)
			get_node(\"SFX/Shoot\").set_bus(\"Underwater\")
			get_node(\"SFX/Music\")._set_playing(true)
		in_water = 1
	
	if (Input.is_action_just_pressed(\"ui_accept\") and can_shoot):
			create_bullet()
			can_shoot = false
			timer.start()
			get_node(\"SFX/Shoot\").playing = true
			
func create_bullet():
		var bullet = BULLET_SCENE.instance()
		get_parent().add_child(bullet)
		if !get_node(\"AnimatedSprite\").flip_h:
			bullet.set_position(get_node(\"Position2D\").get_global_position())
		else:
			var bulletPosition = get_node(\"Position2D\").get_global_position()
			bulletPosition.x -=60
			bullet.get_node(\"Sprite\").set_flip_h(true)
			bullet.set_position(bulletPosition)
			bullet.speed_x = -1"

[sub_resource type="SpriteFrames" id=2]

animations = [ {
"frames": [ ExtResource( 1 ), ExtResource( 2 ), ExtResource( 3 ), ExtResource( 4 ), ExtResource( 5 ) ],
"loop": true,
"name": "Swim",
"speed": 5.0
}, {
"frames": [ ExtResource( 1 ), ExtResource( 2 ), ExtResource( 3 ), ExtResource( 4 ), ExtResource( 5 ) ],
"loop": false,
"name": "Stroke",
"speed": 10.0
}, {
"frames": [ ExtResource( 6 ) ],
"loop": true,
"name": "Float",
"speed": 5.0
}, {
"frames": [ ExtResource( 6 ), ExtResource( 7 ), ExtResource( 8 ), ExtResource( 7 ) ],
"loop": true,
"name": "Walk",
"speed": 5.0
}, {
"frames": [ ExtResource( 7 ) ],
"loop": true,
"name": "Ground",
"speed": 5.0
}, {
"frames": [ ExtResource( 6 ) ],
"loop": true,
"name": "Jump",
"speed": 5.0
} ]
_sections_unfolded = [ "Resource" ]

[sub_resource type="ParticlesMaterial" id=3]

render_priority = 0
trail_divisor = 1
emission_shape = 2
emission_box_extents = Vector3( 32, 10, 32 )
flag_align_y = false
flag_rotate_y = false
flag_disable_z = true
spread = 80.0
flatness = 0.0
gravity = Vector3( 0, -40, 0 )
initial_velocity = 0.0
initial_velocity_random = 0.0
angular_velocity = 0.0
angular_velocity_random = 0.0
orbit_velocity = 0.0
orbit_velocity_random = 0.0
linear_accel = 0.0
linear_accel_random = 0.0
radial_accel = 0.0
radial_accel_random = 0.0
tangential_accel = 0.0
tangential_accel_random = 0.0
damping = 7.56
damping_random = 0.0
angle = 0.0
angle_random = 0.0
scale = 0.59
scale_random = 0.0
color = Color( 0.797009, 0.750015, 0.964844, 1 )
hue_variation = -1.0
hue_variation_random = 0.93
anim_speed = 0.0
anim_speed_random = 0.0
anim_offset = 0.0
anim_offset_random = 0.0
anim_loop = false
_sections_unfolded = [ "Color", "Emission Shape", "Gravity", "Hue Variation", "Initial Velocity", "Orbit Velocity", "Spread" ]

[sub_resource type="RectangleShape2D" id=4]

custom_solver_bias = 0.0
extents = Vector2( 10.8974, 23 )

[sub_resource type="CircleShape2D" id=5]

custom_solver_bias = 0.0
radius = 10.0

[node name="KinematicBody2D" type="KinematicBody2D"]

editor/display_folded = true
position = Vector2( -99.9701, -101.838 )
z_index = 2
input_pickable = false
collision_layer = 1
collision_mask = 7
collision/safe_margin = 0.08
script = SubResource( 1 )
_sections_unfolded = [ "Collision", "Transform", "Z Index" ]
__meta__ = {
"_edit_group_": true
}

[node name="AnimatedSprite" type="AnimatedSprite" parent="." index="0"]

scale = Vector2( 0.75, 0.75 )
frames = SubResource( 2 )
animation = "Float"
playing = true
script = ExtResource( 9 )
_sections_unfolded = [ "Transform", "Visibility", "Z Index" ]

[node name="SFX" type="Node" parent="." index="1"]

editor/display_folded = true

[node name="Music" type="AudioStreamPlayer" parent="SFX" index="0"]

stream = ExtResource( 10 )
volume_db = 0.0
pitch_scale = 1.0
autoplay = false
mix_target = 0
bus = "Master"

[node name="Enter Water" type="AudioStreamPlayer" parent="SFX" index="1"]

stream = ExtResource( 11 )
volume_db = 0.0
pitch_scale = 1.0
autoplay = false
mix_target = 0
bus = "Master"

[node name="Exit Water" type="AudioStreamPlayer" parent="SFX" index="2"]

stream = ExtResource( 12 )
volume_db = 0.0
pitch_scale = 1.0
autoplay = false
mix_target = 0
bus = "Master"

[node name="Shoot" type="AudioStreamPlayer" parent="SFX" index="3"]

stream = ExtResource( 13 )
volume_db = 0.0
pitch_scale = 1.0
autoplay = false
mix_target = 0
bus = "Master"

[node name="Radio" type="Sprite" parent="SFX" index="4"]

position = Vector2( 91.2681, -91.7314 )
z_index = 2
texture = ExtResource( 14 )
_sections_unfolded = [ "Z Index" ]
__meta__ = {
"_edit_group_": true
}

[node name="AudioStreamPlayer2D" type="AudioStreamPlayer2D" parent="SFX/Radio" index="0"]

stream = ExtResource( 15 )
volume_db = -1.0
pitch_scale = 1.0
autoplay = false
max_distance = 487.0
attenuation = 1.0
bus = "Radio"
area_mask = 1

[node name="Particles2D" type="Particles2D" parent="SFX/Radio" index="1"]

emitting = true
amount = 3
lifetime = 2.15
one_shot = false
preprocess = 0.0
speed_scale = 1.0
explosiveness = 0.0
randomness = 0.0
fixed_fps = 0
fract_delta = true
visibility_rect = Rect2( -100, -100, 200, 200 )
local_coords = true
draw_order = 0
process_material = SubResource( 3 )
texture = ExtResource( 16 )
normal_map = null
h_frames = 1
v_frames = 1
_sections_unfolded = [ "Process Material", "Textures", "Time" ]

[node name="Camera2D" type="Camera2D" parent="." index="2"]

anchor_mode = 1
rotating = false
current = true
zoom = Vector2( 1, 1 )
limit_left = -10000000
limit_top = -10000000
limit_right = 10000000
limit_bottom = 10000000
limit_smoothed = false
drag_margin_h_enabled = true
drag_margin_v_enabled = true
smoothing_enabled = false
smoothing_speed = 5.0
offset_v = 0.0
offset_h = 0.0
drag_margin_left = 0.0
drag_margin_top = 0.0
drag_margin_right = 0.0
drag_margin_bottom = 0.0
editor_draw_screen = true
editor_draw_limits = false
editor_draw_drag_margin = false
_sections_unfolded = [ "Drag Margin", "Limit", "Smoothing" ]

[node name="gui" type="Control" parent="Camera2D" index="0" instance=ExtResource( 17 )]

anchor_left = 0.0
anchor_top = 0.0
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = -510.0
margin_top = -298.0
margin_right = 446.0
margin_bottom = 238.0
rect_pivot_offset = Vector2( 0, 0 )
rect_clip_content = false
mouse_filter = 0
mouse_default_cursor_shape = 0
size_flags_horizontal = 1
size_flags_vertical = 1
_sections_unfolded = [ "Focus", "Grow Direction", "Hint", "Margin", "Rect" ]

[node name="CollisionShape2D" type="CollisionShape2D" parent="." index="3"]

position = Vector2( 1, -6 )
shape = SubResource( 4 )
_sections_unfolded = [ "Transform" ]

[node name="CollisionShape2D2" type="CollisionShape2D" parent="." index="4"]

position = Vector2( 1, 23 )
shape = SubResource( 5 )
_sections_unfolded = [ "Transform" ]

[node name="Position2D" type="Position2D" parent="." index="5"]

position = Vector2( 30, 0 )
_sections_unfolded = [ "Transform" ]

[node name="Timer" type="Timer" parent="." index="6"]

process_mode = 1
wait_time = 1.0
one_shot = false
autostart = false


